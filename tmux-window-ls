#!/bin/sh

set -e

tmux list-windows -F '#{window_id} #{window_index} #{pane_current_path}' \
| awk -v HOME="$HOME" 'BEGIN {ORS=" "} {
    path = $3
    
    # Replace home directory with ~
    if (index(path, HOME) == 1) {
        path = "~" substr(path, length(HOME) + 1)
    }
    
    # Split path into components
    split(path, parts, "/")
    
    # Count non-empty parts
    count = 0
    for (i in parts) {
        if (parts[i] != "") count++
    }
    
    # Build display path with max 3 directories
    result = ""
    if (count <= 3) {
        # Show full path if 3 or fewer components
        result = path
    } else {
        # Show last 3 components with ".." prefix
        result = "../"
        start = count - 2
        counter = 0
        for (i = 1; i <= length(parts); i++) {
            if (parts[i] != "") {
                counter++
                if (counter >= start) {
                    if (result != "../") result = result "/"
                    result = result parts[i]
                }
            }
        }
    }
    
    print result, $2, "\"select-window -t", $1 "\""
}' \
| xargs tmux display-menu -T "choose window" -b "rounded"
